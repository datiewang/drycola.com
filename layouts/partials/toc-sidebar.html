<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocSidebar = document.getElementById('toc-sidebar');
    const tocToggle = document.getElementById('toc-toggle');
    const tocLinks = document.querySelectorAll('.toc-sidebar-link');
    
    if (!tocSidebar) return;
    
    // åˆ‡æ¢TOCæ˜¾ç¤º/éšè—
    if (tocToggle) {
        tocToggle.addEventListener('click', function() {
            if (tocSidebar.classList.contains('hidden')) {
                // æ˜¾ç¤ºTOC
                tocSidebar.classList.remove('hidden');
                tocToggle.textContent = 'Ã—';
                tocToggle.title = 'å…³é—­å¿«é€Ÿå¯¼è§ˆ';
            } else {
                // éšè—TOC
                tocSidebar.classList.add('hidden');
                tocToggle.textContent = 'ğŸ“‹';
                tocToggle.title = 'æ‰“å¼€å¿«é€Ÿå¯¼è§ˆ';
            }
        });
    }
    
    // æ»šåŠ¨æ—¶é«˜äº®å½“å‰ç« èŠ‚
    function updateActiveLink() {
        const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        let activeHeading = null;
        
        // æ‰¾åˆ°å½“å‰æœ€æ¥è¿‘çš„æ ‡é¢˜
        for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            const headingTop = heading.offsetTop - 100; // æå‰100pxè§¦å‘
            
            if (scrollTop >= headingTop) {
                activeHeading = heading;
                break;
            }
        }
        
        // æ›´æ–°æ´»åŠ¨é“¾æ¥
        tocLinks.forEach(link => link.classList.remove('active'));
        
        if (activeHeading) {
            const activeId = activeHeading.id;
            const activeLink = document.querySelector(`.toc-sidebar-link[href="#${activeId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }
    }
    
    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    let ticking = false;
    window.addEventListener('scroll', function() {
        if (!ticking) {
            requestAnimationFrame(function() {
                updateActiveLink();
                ticking = false;
            });
            ticking = true;
        }
    });
    
    // åˆå§‹åŒ–æ´»åŠ¨é“¾æ¥
    updateActiveLink();
    
    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                const targetTop = targetElement.offsetTop - 80; // ç•™å‡ºä¸€äº›é—´è·
                window.scrollTo({
                    top: targetTop,
                    behavior: 'smooth'
                });
            }
        });
    });
    
    // æ£€æµ‹TOCæ˜¯å¦åº”è¯¥æ˜¾ç¤ºï¼ˆåªåœ¨æœ‰å†…å®¹æ—¶æ˜¾ç¤ºï¼‰
    if (tocLinks.length === 0) {
        tocSidebar.style.display = 'none';
    }
});
</script>