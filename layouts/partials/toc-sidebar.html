<script>
document.addEventListener('DOMContentLoaded', function() {
    const tocSidebar = document.getElementById('toc-sidebar');
    const tocToggle = document.getElementById('toc-toggle');
    const tocMobileToggle = document.getElementById('toc-mobile-toggle');
    const tocMobileOverlay = document.getElementById('toc-mobile-overlay');
    const tocLinks = document.querySelectorAll('.toc-sidebar-link');
    
    if (!tocSidebar) return;
    
    // æ£€æµ‹TOCæ˜¯å¦åº”è¯¥æ˜¾ç¤ºï¼ˆåªåœ¨æœ‰å†…å®¹æ—¶æ˜¾ç¤ºï¼‰
    if (tocLinks.length === 0) {
        tocSidebar.style.display = 'none';
        const mobileToggle = document.getElementById('toc-mobile-toggle');
        const mobileOverlay = document.getElementById('toc-mobile-overlay');
        if (mobileToggle) {
            mobileToggle.style.display = 'none';
        }
        if (mobileOverlay) {
            mobileOverlay.style.display = 'none';
        }
        return;
    }
    
    // è·å–å½“å‰å±å¹•å°ºå¯¸çŠ¶æ€
    function isMobile() {
        return window.innerWidth <= 1200;
    }
    
    // æ›´æ–°TOCæ˜¾ç¤ºçŠ¶æ€
    function updateTocDisplay() {
        if (isMobile()) {
            // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºæ‚¬æµ®æŒ‰é’®ï¼Œéšè—ä¾§è¾¹æ 
            tocSidebar.classList.add('mobile-mode');
            const mobileToggle = document.getElementById('toc-mobile-toggle');
            if (mobileToggle) {
                mobileToggle.style.display = 'block';
            }
        } else {
            // æ¡Œé¢ç«¯ï¼šéšè—æ‚¬æµ®æŒ‰é’®ï¼Œæ˜¾ç¤ºä¾§è¾¹æ 
            tocSidebar.classList.remove('mobile-mode', 'mobile-open');
            const mobileToggle = document.getElementById('toc-mobile-toggle');
            if (mobileToggle) {
                mobileToggle.style.display = 'none';
            }
            // æ¡Œé¢ç«¯é»˜è®¤æ˜¾ç¤ºï¼Œé™¤éç”¨æˆ·ä¸»åŠ¨éšè—
            if (!tocSidebar.hasAttribute('data-user-hidden')) {
                tocSidebar.classList.remove('hidden');
            }
        }
    }
    
    // æ¡Œé¢ç«¯åˆ‡æ¢TOCæ˜¾ç¤º/éšè—
    if (tocToggle) {
        tocToggle.addEventListener('click', function() {
            if (tocSidebar.classList.contains('hidden')) {
                // æ˜¾ç¤ºTOC
                tocSidebar.classList.remove('hidden');
                tocSidebar.removeAttribute('data-user-hidden');
                tocToggle.textContent = 'Ã—';
                tocToggle.title = 'å…³é—­å¿«é€Ÿå¯¼è§ˆ';
            } else {
                // éšè—TOC
                tocSidebar.classList.add('hidden');
                tocSidebar.setAttribute('data-user-hidden', 'true');
                tocToggle.textContent = 'ğŸ“‹';
                tocToggle.title = 'æ‰“å¼€å¿«é€Ÿå¯¼è§ˆ';
            }
        });
    }
    
    // ç§»åŠ¨ç«¯åˆ‡æ¢TOCæ˜¾ç¤º/éšè—
    if (tocMobileToggle) {
        tocMobileToggle.addEventListener('click', function() {
            if (tocSidebar.classList.contains('mobile-open')) {
                closeMobileToc();
            } else {
                openMobileToc();
            }
        });
    }
    
    // ç§»åŠ¨ç«¯æ‰“å¼€TOC
    function openMobileToc() {
        tocSidebar.classList.add('mobile-open');
        if (tocMobileOverlay) {
            tocMobileOverlay.classList.add('active');
        }
        tocMobileToggle.textContent = 'Ã—';
        tocMobileToggle.title = 'å…³é—­å¿«é€Ÿå¯¼è§ˆ';
        // é˜²æ­¢é¡µé¢æ»šåŠ¨
        document.body.style.overflow = 'hidden';
    }
    
    // ç§»åŠ¨ç«¯å…³é—­TOC
    function closeMobileToc() {
        tocSidebar.classList.remove('mobile-open');
        if (tocMobileOverlay) {
            tocMobileOverlay.classList.remove('active');
        }
        tocMobileToggle.textContent = 'ğŸ“‹';
        tocMobileToggle.title = 'æ‰“å¼€å¿«é€Ÿå¯¼è§ˆ';
        // æ¢å¤é¡µé¢æ»šåŠ¨
        document.body.style.overflow = '';
    }
    
    // ç§»åŠ¨ç«¯ç‚¹å‡»é®ç½©å±‚æˆ–å¤–éƒ¨åŒºåŸŸå…³é—­TOC
    if (tocMobileOverlay) {
        tocMobileOverlay.addEventListener('click', function() {
            if (isMobile() && tocSidebar.classList.contains('mobile-open')) {
                closeMobileToc();
            }
        });
    }
    
    // ç§»åŠ¨ç«¯ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­TOC
    document.addEventListener('click', function(e) {
        if (isMobile() && tocSidebar.classList.contains('mobile-open')) {
            if (!tocSidebar.contains(e.target) && !tocMobileToggle.contains(e.target)) {
                closeMobileToc();
            }
        }
    });
    
    // æ»šåŠ¨æ—¶é«˜äº®å½“å‰ç« èŠ‚
    function updateActiveLink() {
        const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        
        let activeHeading = null;
        
        // æ‰¾åˆ°å½“å‰æœ€æ¥è¿‘çš„æ ‡é¢˜
        for (let i = headings.length - 1; i >= 0; i--) {
            const heading = headings[i];
            const headingTop = heading.offsetTop - 100; // æå‰100pxè§¦å‘
            
            if (scrollTop >= headingTop) {
                activeHeading = heading;
                break;
            }
        }
        
        // æ›´æ–°æ´»åŠ¨é“¾æ¥
        tocLinks.forEach(link => link.classList.remove('active'));
        
        if (activeHeading) {
            const activeId = activeHeading.id;
            const activeLink = document.querySelector(`.toc-sidebar-link[href="#${activeId}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
        }
    }
    
    // ç›‘å¬æ»šåŠ¨äº‹ä»¶
    let ticking = false;
    window.addEventListener('scroll', function() {
        if (!ticking) {
            requestAnimationFrame(function() {
                updateActiveLink();
                ticking = false;
            });
            ticking = true;
        }
    });
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', function() {
        updateTocDisplay();
    });
    
    // å¹³æ»‘æ»šåŠ¨åˆ°ç›®æ ‡ä½ç½®
    tocLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            const targetElement = document.getElementById(targetId);
            
            if (targetElement) {
                const targetTop = targetElement.offsetTop - 80; // ç•™å‡ºä¸€äº›é—´è·
                window.scrollTo({
                    top: targetTop,
                    behavior: 'smooth'
                });
                
                // ç§»åŠ¨ç«¯ç‚¹å‡»é“¾æ¥åè‡ªåŠ¨å…³é—­TOC
                if (isMobile() && tocSidebar.classList.contains('mobile-open')) {
                    closeMobileToc();
                }
            }
        });
    });
    
    // åˆå§‹åŒ–
    updateTocDisplay();
    updateActiveLink();
});
</script>